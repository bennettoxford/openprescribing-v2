{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-lg-5">
        <div class="card">
            <div class="card-body">
                <h1 class="h4">Prescribing query</h1>
                <form>
                    <h2 class="h5">Numerator</h2>
                    {% include "./_bnf_codes_form_controls.html" with field="ntr" codes=ntr_codes product_type=ntr_product_type %}
                    <h2 class="h5">Denominator</h2>
                    {% include "./_bnf_codes_form_controls.html" with field="dtr" codes=dtr_codes product_type=dtr_product_type %}
                    <button type="submit" class="btn btn-primary">Submit</button>
          		</form>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <h1 class="h4">Highlight organisation</h1>
                <div class="position-relative mb-2">
                    <label class="form-label" for="org-search">Name or code of organisation to highlight</label>
                    <input
                        id="org-search"
                        type="search"
                        class="form-control form-control-lg"
                        {% if org %}value="{{ org.name }}"{% endif %}
                        autocomplete="off"
                    />
                    <ul
                        class="list-group position-absolute top-100 start-0 end-0 mt-2 shadow d-none z-3"
                        id="org-results"
                        style="max-height: 18rem; overflow-y: auto;"
                    ></ul>
                </div>
                <div class="form-text">Start typing an organisation name or code to highlight a single organisation.</div>
            </div>
        </div>
    </div>
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-body">
                {% if ntr_codes %}
                <h1 class="h4">Prescribing data</h1>
                <div id="deciles-chart-container" class="py-3">Loading chart...</div>
                <div class="row">
                    <div class="col-12">
                        <fieldset>
                            <h2 class="h5">Show prescribing</h2>
                            <input type="radio" id="decile" name="chart_type" value="decile" selected>
                            <label for="decile">Deciles</label>
                            <a href="#deciles-help" class="link-secondary d-inline-flex align-items-center" data-bs-toggle="modal">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    class="bi bi-info-circle"
                                    viewBox="0 0 16 16"
                                    focusable="false"
                                >
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z" />
                                    <circle cx="8" cy="4.5" r="1" />
                                </svg>
                            </a>
                            <br>
                            <input type="radio" id="all_orgs_line_chart" name="chart_type" value="all_orgs_line_chart">
                            <label for="all_orgs_line_chart">All organisations (line chart)</label><br>
                            <input type="radio" id="all_orgs_dots_chart" name="chart_type" value="all_orgs_dots_chart">
                            <label for="all_orgs_dots_chart">All organisations (dots chart)</label><br>
                        </fieldset>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <h2 class="h5">Numerator</h2>
                        {% include "./_search_description.html" with description=ntr_description %}
                    </div>
                    <div class="col-6">
                        <h2 class="h5">Denominator</h2>
                        {% include "./_search_description.html" with description=dtr_description %}
                    </div>
                </div>
                {% if org %}
                <div class="row">
                    <div class="col-12">
                        <h2 class="h5">Organisation</h2>
                        {{ org.name }}
                    </div>
                </div>
                {% endif %}
                {% if ntr_dtr_intersection_table %}
                <div class="row mt-3">
                    <div class="col-12">
                        <p>
                            <button
                                class="btn btn-secondary"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapsePresentations"
                            >
                            Presentations
                            </button>
                        </p>
                        <div class="collapse" id="collapsePresentations">
                            <div class="card card-body">
                            {% include "./_bnf_codes_intersection_table.html" with intersection_table=ntr_dtr_intersection_table %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center text-muted py-5">
                    <p>Search for BNF codes to see prescribing data.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal" id="deciles-help" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deciles-help-title">Understanding the deciles chart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>
                    The <span style="color: blue">blue</span> lines show deciles.
                    There are nine deciles and they divide the sorted data into ten equal parts.
                </p>
                <p>
                    The thickest blue line, with long dashes rather than short dashes, shows the median.
                    The median is the fifth decile.
                    Half of all organisations are above the median; half are below.
                </p>
                <p>
                    The <span style="color: red">red</span> line, if present, highlights a single organisation.
                </p>
                <h6>Understanding the median</h6>
                <p>
                    To understand deciles, it helps to understand the median.
                </p>
                <p>
                    Imagine we have prescribing data for nine practices for one month.
                    Let's order the prescribing data from smallest to largest.
                </p>
                <pre><code>[4, 16, 39, 40, 43, 56, 58, 67, 97]</code></pre>
                <p>
                    The median splits the values into the lower half and the higher half.
                    In this case, the median is <code>43</code>.
                    The four values in the lower half are less than the median.
                    The four values in the higher half are greater than the median.
                </p>
                <p>
                    Calculating the median isn't always as straightforward.
                    What should we do when there are ten practices, for example?
                </p>
                <pre><code>[4, 16, 39, 40, 43, 44, 56, 58, 67, 97]</code></pre>
                <p>
                    In this case,
                    two values separate the lower half from the higher half: <code>43</code> and <code>44</code>.
                    In OpenPrescribing,
                    we use the value that's half-way between these two values as the median: <code>43.5</code>.
                </p>
                <p>
                    The median is the fifth decile.
                    With the other deciles, we still split the values into a lower part and a higher part.
                    However, the number of values in each part is different.
                    For example, 20% of values are less than the second decile and 80% of values are greater than the second decile.
                </p>
                <h6>Understanding a single organisation</h6>
                <p>
                    If you've chosen to highlight a single organisation,
                    then you may be wondering how it relates to the median.
                    If its line is below the median,
                    then its prescribing is less than the median.
                    Similarly, if its line is above the median,
                    then its prescribing is greater than the median.
                    The same is true for the other deciles.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="bnf-tree-modal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bnf-tree-modal-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% include "_bnf_tree.html" %}
      </div>
      <div class="modal-footer">
        <div class="me-auto text-muted small">
          Control-click (command-click on Mac) on an item to include or exclude it.
        </div>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Update Query</button>
      </div>
    </div>
  </div>
</div>

{% include "_bnf_table_modal.html" with include_footer=True %}
{% endblock %}

{% block extra_js %}
{{ orgs|json_script:"orgs" }}
{{ org_types|json_script:"org-types" }}
{{ prescribing_deciles_url|json_script:"prescribing-deciles-url" }}
{{ prescribing_all_orgs_url|json_script:"prescribing-all-orgs-url" }}
{{ deciles_chart|json_script:"deciles-chart" }}
<script src="https://cdn.jsdelivr.net/npm/vega@6.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
<script type="module" src="{% static 'js/prescribing-chart.js' %}"></script>
<script type="module" src="{% static 'js/prescribing-query.js' %}"></script>
{% endblock %}
